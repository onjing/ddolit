<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CIST Web Implementation - 자동 진행</title>
<style>
    * {
        margin: 0; padding: 0; box-sizing: border-box;
    }
    body {
        font-family: 'Malgun Gothic', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
    }
    .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        overflow: hidden;
        padding: 30px;
    }
    .header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 30px;
        text-align: center;
        border-radius: 15px 15px 0 0;
    }
    .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 700;
    }
    .warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-weight: 600;
        text-align: center;
    }
    .start-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 1.2em;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
        margin: 20px auto;
        font-weight: 600;
    }
    .start-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    .start-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    .test-area {
        display: none;
        margin-top: 30px;
        text-align: center;
    }
    .progress-info {
        background: #fff3e0;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-weight: 600;
        font-size: 1.2em;
    }
    .question-text {
        font-size: 1.3em;
        color: #333;
        margin-bottom: 30px;
        line-height: 1.5;
        min-height: 80px;
    }
    .evaluation-result {
        background: #f1f8e9;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        border-left: 4px solid #4caf50;
        font-weight: 600;
        font-size: 1.2em;
    }
    .final-result {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 40px;
        border-radius: 15px;
        text-align: center;
        margin-top: 40px;
        display: none;
    }
    .final-score {
        font-size: 3em;
        font-weight: bold;
        margin-bottom: 10px;
    }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CIST 검사 자동 진행</h1>
            <p>음성 재생과 녹음이 자동으로 진행됩니다.</p>
        </div>
        <div class="warning">
            ⚠️ OpenAI API Key와 오디오 파일 경로를 입력해주세요.
        </div>

        <div class="setup-section">
            <label for="openaiKey"><strong>OpenAI API Key:</strong></label>
            <input type="password" id="openaiKey" placeholder="sk-..." style="width:100%; padding:10px; margin:10px 0 20px 0; font-size:1em; border-radius:6px; border:1px solid #ccc;">
            <label for="audioBaseUrl"><strong>Audio Files Base URL:</strong></label>
            <input type="url" id="audioBaseUrl" placeholder="https://onjing.github.io/ddolit/audio/" value="./audio/" style="width:100%; padding:10px; margin:10px 0 30px 0; font-size:1em; border-radius:6px; border:1px solid #ccc;">
        </div>

        <button class="start-button" id="initBtn" onclick="initializeTest()">검사 시작</button>

        <div class="test-area" id="testArea">
            <div class="progress-info" id="progressInfo">
                문제 <span id="currentQ">1</span> / <span id="totalQ">11</span>
            </div>
            <div class="question-text" id="questionText"></div>
            <div class="evaluation-result" id="evaluationResult" style="display:none;">
                평가 결과: <span id="evaluationText"></span>
            </div>
        </div>

        <div class="final-result" id="finalResult">
            <div class="final-score" id="finalScore"></div>
            <div>최종 검사 결과</div>
        </div>
    </div>

<script>
    // 문제 스크립트 (Python 코드와 동일)
    const script = [
        {
            label: 'hello',
            file: 'ddolit_CIST_Q_hello.wav',
            content: '안녕하세요. 지금부터, 기억력과 사고능력을 살펴보기 위한, 질문들을 드릴거에요.',
            hasAnswer: false
        },
        {
            label: 'Q1_2',
            file: 'ddolit_CIST_Q_Q1_2.wav',
            content: '올해는 몇 년도인가요',
            answer: `${new Date().getFullYear()}년`,
            hasAnswer: true
        },
        {
            label: 'Q1_3',
            file: 'ddolit_CIST_Q_Q1_3.wav',
            content: '지금은 몇 월인가요?',
            answer: `${new Date().getMonth() + 1}월`,
            hasAnswer: true
        },
        {
            label: 'Q1_4',
            file: 'ddolit_CIST_Q_Q1_4.wav',
            content: '오늘은 며칠인가요?',
            answer: `${new Date().getDate()}일`,
            hasAnswer: true
        },
        {
            label: 'Q2',
            file: 'ddolit_CIST_Q_Q2.wav',
            content: '지금 계신 곳은 어디인가요? 어디에 계신지 말씀해 주세요.',
            answer: '집, 병원, 서울시, 경기도, 강남구 등 사람이 거주하거나 머무를 수 있는 장소',
            hasAnswer: true
        },
        {
            label: 'Q3',
            file: 'ddolit_CIST_Q_Q3.wav',
            content: '지금부터 외우셔야 하는 문장을 불러드릴게요. 끝까지 잘 들어주시고, 따라해주세요. 민수는 자전거를 타고 공원에 가서 열한시부터 야구를 했다',
            answer: '민수는 자전거를 타고 공원에 가서 11시부터 야구를 했다',
            hasAnswer: true
        },
        {
            label: 'Q4_1',
            file: 'ddolit_CIST_Q_Q4_1.wav',
            content: '제가 불러드리는 숫자를, 그대로 따라해주세요. 육, 구, 칠, 삼',
            answer: '6973',
            hasAnswer: true
        },
        {
            label: 'Q4_2',
            file: 'ddolit_CIST_Q_Q4_2.wav',
            content: '오, 칠, 이, 팔, 사',
            answer: '57284',
            hasAnswer: true
        },
        {
            label: 'Q5',
            file: 'ddolit_CIST_Q_Q5.wav',
            content: '제가 불러드리는 말을, 끝에서부터, 거꾸로 따라해주세요. 금수강산',
            answer: '산강수금',
            hasAnswer: true
        },
        {
            label: 'Q6',
            file: 'ddolit_CIST_Q_Q6.wav',
            content: '제가 조금 전에 외우라고 불러드렸던 문장을 다시 한번 말씀해주세요.',
            answer: '민수는 자전거를 타고 공원에 가서 열한시부터 야구를 했다',
            hasAnswer: true
        },
        {
            label: 'Q7',
            file: 'ddolit_CIST_Q_Q7.wav',
            content: '지금부터 제가 그만이라고 말할 때까지 과일이나 채소를 최대한 많이 이야기해주세요.',
            answer: '과일이나 채소를 0-8개: 0점 / 9-14개: 1점 / 15개 이상: 2점',
            hasAnswer: true
        }
    ];

    let currentQuestionIndex = 0;
    let correctCount = 0;
    let totalCount = 0;
    let openaiApiKey = '';
    let audioBaseUrl = '';
    let recognition;

    // 음성 인식 객체 초기화
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
    } else if ('SpeechRecognition' in window) {
        recognition = new SpeechRecognition();
    } else {
        recognition = null;
    }

    if (recognition) {
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'ko-KR';
    }

    async function initializeTest() {
        openaiApiKey = document.getElementById('openaiKey').value.trim();
        audioBaseUrl = document.getElementById('audioBaseUrl').value.trim();

        if (!openaiApiKey) {
            alert('OpenAI API Key를 입력해주세요.');
           
